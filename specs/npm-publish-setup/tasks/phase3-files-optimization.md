# Phase 3: filesフィールドと公開ファイル最適化 計画書

## タスク目次

- 1. 公開に必要なファイルリストの作成 - 状態: 未着手 - TDD: ⬜ Red / ⬜ Green / ⬜ Refactor
- 2. package.jsonのfilesフィールド追加 - 状態: 未着手 - TDD: ⬜ Red / ⬜ Green / ⬜ Refactor
- 3. 除外すべきファイル・ディレクトリの確認 - 状態: 未着手 - TDD: ⬜ Red / ⬜ Green / ⬜ Refactor
- 4. .npmignoreファイルの作成判断 - 状態: 未着手 - TDD: ⬜ Red / ⬜ Green / ⬜ Refactor
- 5. 機密情報の除外確認 - 状態: 未着手 - TDD: ⬜ Red / ⬜ Green / ⬜ Refactor

**番号付けルール:**
- 全て単一番号で直列実行（1 → 2 → 3 → 4 → 5）

## Phase概要
- **Phase名**: filesフィールドと公開ファイル最適化
- **状態**: 未着手
- **目標**: 公開に含めるファイルを最適化し、不要なファイルや機密情報を除外して、パッケージサイズを最小化する

## TDD & 設計原則の適用

### TDDアプローチ
1. **Red（検証スクリプト作成）**: 公開ファイルに不要なファイルや機密情報が含まれていないことを検証するスクリプトを作成
2. **Green（設定実施）**: filesフィールドを追加し、必要なファイルのみを指定
3. **Refactor（最適化）**: パッケージサイズを確認し、不要なファイルをさらに削減

### 設計原則の適用方針

- **最小限の公開**: 実行に必要なファイルのみを公開し、開発用ファイルは除外

## 依存関係
- **前提条件**: Phase 2完了（binフィールド設定、dist/index.js存在確認済み）
- **ブロッカー**: なし
- **後続Phaseへの影響**: Phase 5でnpm packを実行する際、このフィールド設定が反映される

## 実装する機能
- 機能3: ファイル選択 - 公開に含めるファイルの最適化

## タスク詳細

### タスク1: 公開に必要なファイルリストの作成
- **説明**:
  - npm公開に必要なファイルをリストアップ
  - 必須ファイル: dist/, README.md, LICENSE
  - package.jsonは自動的に含まれる
- **開始日時**:
- **TDDステップ**:
  - [ ] Red: 必須ファイルが存在することを検証するスクリプトを作成
  - [ ] Green: 必須ファイルの存在を確認
  - [ ] Refactor: リストを整理
- **依存関係**: Phase 2完了後
- **状態**: 未着手

### タスク2: package.jsonのfilesフィールド追加
- **説明**:
  - filesフィールドをpackage.jsonに追加
  - 以下を含める: `["dist/", "README.md", "LICENSE"]`
  - package.jsonは自動的に含まれるため明示不要
- **開始日時**:
- **TDDステップ**:
  - [ ] Red: filesフィールドが存在し、必要なパスが含まれていることを検証
  - [ ] Green: filesフィールドを追加
    ```json
    {
      "files": [
        "dist/",
        "README.md",
        "LICENSE"
      ]
    }
    ```
  - [ ] Refactor: 冗長な記述を削除
- **依存関係**: タスク1完了後
- **状態**: 未着手

### タスク3: 除外すべきファイル・ディレクトリの確認
- **説明**:
  - 公開から除外すべきファイル・ディレクトリを確認
  - 除外対象: src/, tests/, specs/, .github/, node_modules/, tsconfig.json, vitest.config.ts, eslint.config.ts, coverage/, logs/
  - filesフィールドで明示的に含めないことで自動的に除外される
- **開始日時**:
- **TDDステップ**:
  - [ ] Red: 除外すべきファイルが公開対象に含まれていないことを検証
  - [ ] Green: filesフィールドの設定により除外されることを確認
  - [ ] Refactor: 不要
- **依存関係**: タスク2完了後
- **状態**: 未着手

### タスク4: .npmignoreファイルの作成判断
- **説明**:
  - .npmignoreファイルが必要かどうか判断
  - filesフィールドで十分な場合は作成不要
  - 特定のファイルを明示的に除外する必要がある場合のみ作成
  - 結論: filesフィールドで十分なため、.npmignoreは作成しない
- **開始日時**:
- **TDDステップ**:
  - [ ] Red: 不要
  - [ ] Green: filesフィールドの設定を確認し、.npmignore不要と判断
  - [ ] Refactor: 不要
- **依存関係**: タスク3完了後
- **状態**: 未着手

### タスク5: 機密情報の除外確認
- **説明**:
  - 機密情報が公開対象に含まれていないことを確認
  - 除外すべき機密情報: .env, .env.*, APIキー、シークレット
  - filesフィールドで明示的に含めないことで除外される
  - 念のため、.envファイルの存在を確認し、含まれていないことを検証
- **開始日時**:
- **TDDステップ**:
  - [ ] Red: .envなどの機密情報ファイルが公開対象に含まれていないことを検証
  - [ ] Green: filesフィールドの設定により除外されることを確認
  - [ ] Refactor: 不要
- **依存関係**: タスク4完了後
- **状態**: 未着手

## テスト戦略

- **検証スクリプト**:
  - filesフィールドが正しく設定されているか検証
  - 必須ファイル（dist/, README.md, LICENSE）が含まれているか検証
  - 機密情報ファイル（.env等）が含まれていないか検証

## Phase完了条件
- [ ] 全タスク完了
- [ ] filesフィールドが正しく設定済み
- [ ] 必須ファイルが全て含まれている
- [ ] 開発用ファイルが除外されている
- [ ] 機密情報が除外されている
- [ ] 検証スクリプトが全て成功
- [ ] コードレビュー承認

## 技術的課題と解決方針
- **課題**: .npmignoreとfilesフィールドのどちらを使うべきか
  - **解決方針**: filesフィールドを使用（ホワイトリスト方式で明示的）

## リスク管理
- **リスク**: 機密情報が誤って公開される
  - **対策**: 検証スクリプトで.envなどが含まれていないことを確認
- **リスク**: 必須ファイルが除外される
  - **対策**: 検証スクリプトで必須ファイルの存在を確認

## 次Phaseへの引き継ぎ事項
- Phase 4でpublishConfig設定後、Phase 5でnpm packを実行してファイル内容を検証する
- filesフィールドが設定され、公開ファイルの最適化が完了
