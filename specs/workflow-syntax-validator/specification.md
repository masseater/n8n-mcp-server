# 詳細仕様書

## 既存実装分析（czlonkowski/n8n-mcp）

### 📋 実装済みValidation機能の詳細

**czlonkowski/n8n-mcp**が既に以下の機能を実装済み：

#### 1. `validate_workflow` - 包括的ワークフロー検証
- **機能**: 構造、接続、式、AIツールの全体検証
- **パフォーマンス**: 100-500ms
- **プロファイル**: minimal/runtime/ai-friendly/strict
- **検証内容**:
  - 基本構造（nodes配列、connections オブジェクト）
  - 重複ノード名・ID検出
  - 接続整合性（循環参照、孤立ノード）
  - 式構文検証
  - AI特化ノード検証

#### 2. `validate_node_minimal` - 高速必須フィールドチェック
- **機能**: 必須フィールドのみの瞬時チェック
- **パフォーマンス**: Instant
- **用途**: リアルタイム検証、インタラクティブ設定

#### 3. `validate_node_operation` - ノード設定詳細検証
- **機能**: 操作固有パラメータの詳細検証
- **検証内容**: タイプ検証、依存関係チェック、値範囲検証

#### 4. WorkflowValidatorクラスの高度機能
- **循環参照検出**: ループノード（SplitInBatches）は例外処理
- **AI特化検証**: LangChainノードの専用バリデーター
- **エラー修復提案**: 具体的な修正方法を自動生成
- **統計情報**: 詳細な検証統計の提供

### 📊 学習ポイント
1. **プロファイルベース検証**: 用途に応じた検証レベルの調整
2. **段階的検証**: 構造→ノード→接続→式の順序
3. **エラー分類**: error/warningの適切な分類
4. **修復提案**: 具体的で実行可能な修正方法の提示
5. **AI対応**: AI Agent、LangChainノードの特別扱い

## 機能要件

### 機能1: 基本ワークフロー構文バリデーション
- **概要**: ワークフローJSONの基本構造と必須フィールドの妥当性を検証する
- **優先度**: High
- **実装Phase**: Phase 1
- **ユースケース**:
  - **アクター**: ワークフロー開発者、AI支援システム
  - **前提条件**: ワークフローJSONデータまたはファイルパスが提供される
  - **基本フロー**:
    1. 入力データの形式チェック（JSON形式）
    2. 必須フィールドの存在確認（name, nodes, connections）
    3. 各フィールドのデータタイプ検証
    4. 基本的な構造整合性チェック
  - **代替フロー**:
    - JSONパース失敗時: FileErrorを返す
    - 必須フィールド欠如時: ValidationErrorを返す
  - **事後条件**: バリデーション結果とエラー詳細が返される
- **入力**:
  - `workflow`: ワークフローJSONオブジェクト または
  - `filePath`: ワークフローJSONファイルのパス
- **出力**:
  - `success`: boolean（バリデーション成功/失敗）
  - `errors`: エラー詳細配列
  - `warnings`: 警告詳細配列
- **ビジネスルール**:
  - nameフィールドは空文字列不可
  - nodesは配列である必要がある
  - connectionsはオブジェクトである必要がある
- **バリデーション**:
  - JSON形式の妥当性
  - 必須フィールドの型チェック
  - 文字列長制限（name: 最大255文字）

### 機能2: ノード定義バリデーション
- **概要**: 個々のノードの定義とパラメータの妥当性を検証する
- **優先度**: High
- **実装Phase**: Phase 1
- **ユースケース**:
  - **アクター**: ワークフロー開発者
  - **前提条件**: 基本構文バリデーションが完了している
  - **基本フロー**:
    1. 各ノードの必須フィールド検証（id, name, type, typeVersion, position, parameters）
    2. ノードID重複チェック
    3. ノード名重複チェック
    4. position配列の形式チェック
    5. parametersオブジェクトの構造チェック
  - **代替フロー**:
    - 必須フィールド欠如時: 該当ノードのValidationErrorを記録
    - ID重複時: DuplicateIdErrorを記録
  - **事後条件**: 全ノードのバリデーション結果が収集される
- **入力**: ワークフローのnodesフィールド
- **出力**: ノード別エラー・警告リスト
- **ビジネスルール**:
  - ノードIDはワークフロー内で一意
  - ノード名はワークフロー内で一意（推奨）
  - positionは[number, number]形式
  - typeVersionは正の整数
- **バリデーション**:
  - 必須フィールドの存在と型チェック
  - ID・名前の一意性チェック
  - 座標値の妥当性チェック

### 機能3: ノードタイプ固有バリデーション
- **概要**: 各ノードタイプ固有の要件とパラメータを検証する
- **優先度**: High
- **実装Phase**: Phase 2
- **ユースケース**:
  - **アクター**: ワークフロー開発者
  - **前提条件**: 基本ノードバリデーションが完了している
  - **基本フロー**:
    1. ノードタイプの有効性チェック
    2. ノードタイプ固有の必須パラメータ検証
    3. パラメータ値の形式・範囲チェック
    4. 依存関係のあるパラメータの整合性チェック
  - **代替フロー**:
    - 未知のノードタイプ: UnknownNodeTypeWarningを記録
    - 必須パラメータ欠如: MissingParameterErrorを記録
  - **事後条件**: ノードタイプ固有のバリデーション結果が記録される
- **入力**: ノードオブジェクトとノードタイプ定義
- **出力**: ノードタイプ固有のエラー・警告リスト
- **ビジネスルール**:
  - **不明**: サポートするノードタイプの範囲（案A: n8n公式ノードのみ、案B: カスタムノード含む、案C: 設定可能）
  - **不明**: 未知のノードタイプの扱い（案A: エラー、案B: 警告、案C: 無視）
- **バリデーション**:
  - ノードタイプの存在チェック
  - 必須パラメータの存在と型チェック
  - パラメータ値の範囲・形式チェック

### 機能4: 接続関係バリデーション
- **概要**: ノード間の接続の妥当性と整合性を検証する
- **優先度**: High
- **実装Phase**: Phase 1
- **ユースケース**:
  - **アクター**: ワークフロー開発者
  - **前提条件**: ノードバリデーションが完了している
  - **基本フロー**:
    1. 接続先ノードの存在確認
    2. 接続インデックスの妥当性チェック
    3. 接続タイプの整合性確認
    4. 循環参照の検出
  - **代替フロー**:
    - 存在しないノードへの接続: InvalidConnectionErrorを記録
    - 循環参照検出: CircularReferenceErrorを記録
  - **事後条件**: 全接続の妥当性が検証される
- **入力**: ワークフローのconnectionsフィールドとnodesフィールド
- **出力**: 接続別エラー・警告リスト
- **ビジネスルール**:
  - 接続先ノードは必ず存在する必要がある
  - 接続インデックスは0以上の整数
  - 循環参照は禁止
- **バリデーション**:
  - 接続先ノードの存在チェック
  - インデックス値の妥当性チェック
  - グラフ構造の循環チェック

### 機能5: 高度な接続パターン検証
- **概要**: 複雑な接続パターンや特殊なノードタイプの接続を検証する
- **優先度**: Medium
- **実装Phase**: Phase 2
- **ユースケース**:
  - **アクター**: 上級ワークフロー開発者
  - **前提条件**: 基本接続バリデーションが完了している
  - **基本フロー**:
    1. 条件分岐ノード（IF、Switch）の出力パターンチェック
    2. ループ構造の妥当性検証
    3. サブワークフローの接続整合性チェック
    4. 複数入出力ノードの接続バランスチェック
  - **代替フロー**:
    - 無効な分岐パターン: InvalidBranchPatternWarningを記録
    - 不完全なループ: IncompleteLoopWarningを記録
  - **事後条件**: 高度な接続パターンの検証結果が記録される
- **入力**: ワークフロー全体とノードタイプ定義
- **出力**: 高度なパターンに関するエラー・警告リスト
- **ビジネスルール**:
  - **不明**: 条件分岐の必須出力数（案A: true/false両方必須、案B: 片方のみ可、案C: 設定可能）
  - **不明**: ループの最大深度制限（案A: 制限なし、案B: 10階層、案C: 設定可能）
- **バリデーション**:
  - 分岐ノードの出力パターンチェック
  - ループ構造の完全性チェック
  - サブワークフローの整合性チェック

### 機能6: エラー報告とフォーマット機能
- **概要**: バリデーション結果を分かりやすい形式で報告する
- **優先度**: Medium
- **実装Phase**: Phase 3
- **ユースケース**:
  - **アクター**: ワークフロー開発者、デバッグ作業者
  - **前提条件**: バリデーション処理が完了している
  - **基本フロー**:
    1. エラーの重要度分類（Error, Warning, Info）
    2. エラーメッセージの多言語対応
    3. エラー位置の特定とハイライト
    4. 修正提案の生成
  - **代替フロー**:
    - エラーなしの場合: 成功メッセージと統計情報を表示
  - **事後条件**: 構造化されたレポートが生成される
- **入力**: バリデーション結果オブジェクト
- **出力**: フォーマットされたエラーレポート
- **ビジネスルール**:
  - **不明**: エラーメッセージの言語（案A: 英語のみ、案B: 日本語のみ、案C: 多言語対応）
  - **不明**: 修正提案の詳細度（案A: 簡潔な提案、案B: 詳細な手順、案C: コード例付き）
- **バリデーション**:
  - レポート形式の妥当性
  - メッセージの可読性チェック

## 非機能要件

### セキュリティ
- **入力データのサニタイゼーション**: 悪意のあるJSONペイロードの検出と拒否
- **ファイルアクセス制限**: 指定されたディレクトリ外のファイルへのアクセス禁止
- **メモリ制限**: 大規模なワークフローによるメモリ枯渇の防止
- **処理時間制限**: DOSアタック防止のための処理時間上限設定
- **ログ記録**: セキュリティ関連イベントの監査ログ記録
- **機密情報保護**: パラメータ内の認証情報等の機密データの適切な処理

### パフォーマンス
- **レスポンスタイム**:
  - 小規模ワークフロー（10ノード未満）: 100ms以内
  - 中規模ワークフロー（10-50ノード）: 500ms以内
  - 大規模ワークフロー（50ノード以上）: **不明**（案A: 1秒以内、案B: 5秒以内、案C: 制限なし）
- **同時処理**: **不明**（案A: 同時処理なし、案B: 5リクエスト並列、案C: 制限なし）
- **メモリ使用量**: 1ワークフローあたり最大**不明**（案A: 10MB、案B: 100MB、案C: 制限なし）

### 可用性
- **稼働率**: MCPサーバーと同等の可用性を維持
- **エラー処理**: 部分的な障害時でも可能な限りバリデーション結果を返す
- **復旧時間**: バリデーション機能の障害からの自動復旧

### 保守性
- **コード品質**: 既存コードベースと同等の品質基準を維持
- **テストカバレッジ**: 90%以上のコードカバレッジ
- **ドキュメント**: API仕様書とユーザーガイドの整備
- **拡張性**: 新しいノードタイプやバリデーションルールの追加が容易

### ユーザビリティ
- **エラーメッセージ**: 技術者以外にも理解しやすい明確なメッセージ
- **修正提案**: 具体的で実行可能な修正方法の提示
- **進捗表示**: 大規模ワークフローのバリデーション進捗の表示
- **結果フィルタリング**: エラーレベルや種類による結果のフィルタリング機能

## データ要件
### データモデル概要
- **ワークフローデータ**: n8nのIWorkflow形式に準拠
- **バリデーション結果**: 構造化されたエラー・警告オブジェクト
- **ノードタイプ定義**: ノードタイプ別のスキーマ定義
- **設定データ**: バリデーションルールとしきい値の設定

### データ保持期間
- **バリデーション結果**: セッション期間中のみ（永続化なし）
- **ログデータ**: **不明**（案A: 保存しない、案B: 30日間、案C: 設定可能）

### データ移行要件
- 既存のZodスキーマとの互換性維持
- 新しいバリデーションルールの段階的導入

## インターフェース要件
### 外部システム連携
- **n8n API**: ノードタイプ定義の取得（将来的な機能）
- **ファイルシステム**: ワークフローJSONファイルの読み込み
- **既存MCPツール**: 他のワークフローツールとの連携

### API仕様概要
#### validate_workflow
```typescript
interface ValidateWorkflowArgs {
  workflow: WorkflowDefinition;
  strict?: boolean;
  includeWarnings?: boolean;
  raw?: boolean;
}

interface ValidationResponse {
  success: boolean;
  message: string;
  data: {
    valid: boolean;
    errors: ValidationError[];
    warnings: ValidationWarning[];
    statistics: ValidationStatistics;
  };
}
```

#### validate_workflow_from_file
```typescript
interface ValidateWorkflowFromFileArgs {
  filePath: string;
  strict?: boolean;
  includeWarnings?: boolean;
  raw?: boolean;
}
// レスポンスはvalidate_workflowと同じ
```

### データフォーマット
- **入力**: JSON形式のワークフロー定義
- **出力**: 構造化されたバリデーション結果JSON
- **エラー形式**: MCPプロトコルに準拠したエラーレスポンス

## 制約条件
### 技術的制約
- **Zodライブラリ**: バリデーションロジックはZodスキーマベースで実装
- **TypeScript**: 既存コードベースとの整合性のため型安全性を重視
- **MCPプロトコル**: MCPツールの仕様に準拠した実装
- **Node.js環境**: 既存の実行環境との互換性維持

### ビジネス的制約
- **既存機能への影響**: 既存のMCPツールに影響を与えない実装
- **リソース制限**: 追加のサーバーリソースを最小限に抑制
- **開発期間**: **不明**（具体的なデッドラインの設定）

### 法的・規制上の制約
- **データプライバシー**: ワークフロー内の個人情報の適切な取り扱い
- **ライセンス**: 使用するライブラリのライセンス互換性
- **セキュリティ基準**: 企業セキュリティポリシーへの準拠
