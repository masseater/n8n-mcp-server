# Phase 8: ドキュメント更新とE2Eテスト 計画書

## タスク目次

- 1. [CLAUDE.mdへの新ツール情報追加] - 状態: 未着手 - TDD: ⬜ Red / ⬜ Green / ⬜ Refactor
- 2. [AIエージェント向け使用ガイドラインの作成] - 状態: 未着手 - TDD: ⬜ Red / ⬜ Green / ⬜ Refactor
- 3. [実際のn8nサーバーでのE2Eテスト] - 状態: 未着手 - TDD: ⬜ Red / ⬜ Green / ⬜ Refactor
- 4. [Claude CodeからのMCP経由動作確認] - 状態: 未着手 - TDD: ⬜ Red / ⬜ Green / ⬜ Refactor
- 5. [overview.mdの更新（Phase完了状態の反映）] - 状態: 未着手 - TDD: ⬜ Red / ⬜ Green / ⬜ Refactor

**番号付けルール:**
- 全て直列実行（タスク間に依存関係あり）

**並列実行の判断基準（明示的並列宣言方式）:**
- このPhaseでは並列実行可能なタスクなし

## Phase概要
- **Phase名**: ドキュメント更新とE2Eテスト
- **状態**: 未着手
- **目標**: CLAUDE.mdへの新ツール情報追加、実際のn8nサーバーでのE2Eテスト、プロジェクト完了

## TDD & 設計原則の適用

### TDDアプローチ
このPhaseでは以下のTDDサイクルを適用します：

1. **Red（テスト作成）**: E2Eテストのシナリオ作成（実際のn8nサーバー使用）
2. **Green（最小実装）**: ドキュメント作成とE2Eテスト実施
3. **Refactor（リファクタリング）**: ドキュメントの明確化とE2Eテストの最適化

### 設計原則の適用方針

- **単一責任の原則 (SRP)**: ドキュメントは各ツールの使用方法のみを記述、実装詳細は含まない
- **開放/閉鎖の原則 (OCP)**: 既存のドキュメント構造を変更せず、新規セクションを追加
- **リスコフの置換原則 (LSP)**: E2Eテストは統合テストのインターフェースを保つ
- **最小限の公開**: ドキュメントはAIエージェント向けの必要最小限の情報のみを記載
- **依存性逆転の原則 (DIP)**: E2Eテストは実際のN8nApiClientを使用（モックではない）

⚠️ **インターフェースや抽象クラスは使用しない**: ドキュメントは具体的な使用例を記載

## 依存関係
- **前提条件**: Phase 7（2ツール連携統合テスト）の完了
- **ブロッカー**: なし
- **後続Phaseへの影響**: プロジェクト完了

## 実装する機能
- CLAUDE.mdへの新ツール情報追加
- AIエージェント向け使用ガイドラインの作成
- 実際のn8nサーバーでのE2Eテスト
- Claude CodeからのMCP経由動作確認
- overview.mdの更新（Phase完了状態の反映）

## タスク詳細

### タスク1: CLAUDE.mdへの新ツール情報追加
- **説明**:
  - CLAUDE.mdの「Available MCP Tools」セクションに2つの新ツールを追加
  - get_executionツールの更新（サマリーレスポンスの説明追加）
  - get_execution_by_nodeツールの新規追加
  - 各ツールのパラメータ、レスポンス構造、使用例を記載
  - Context Optimization Strategyセクションの更新（新ツールのトークン削減率を記載）
- **開始日時**: （未着手の場合は空欄）
- **TDDステップ**:
  - [ ] Red: ドキュメントの構造を検証するテスト作成（markdownのリント）
  - [ ] Green: ドキュメント作成
  - [ ] Refactor: ドキュメントの明確化と誤字脱字修正
- **依存関係**: なし
- **状態**: 未着手

### タスク2: AIエージェント向け使用ガイドラインの作成
- **説明**:
  - 「When to use get_execution vs get_execution_by_node」セクションを追加
  - AIエージェントが適切にツールを選択できるガイドライン
  - 使用例:
    - ユーザーが「実行の状態を確認して」→ get_executionを使用
    - ユーザーが「エラー原因を調べて」→ get_execution → get_execution_by_node
    - ユーザーが「特定ノードの詳細を見せて」→ get_execution_by_node
  - レスポンスサイズの考慮事項（いつrawオプションを使うべきか）
- **開始日時**: （未着手の場合は空欄）
- **TDDステップ**:
  - [ ] Red: ガイドラインの明確性を検証するテスト作成（AIエージェントの判断シミュレーション）
  - [ ] Green: ガイドライン作成
  - [ ] Refactor: 具体例の追加と明確化
- **依存関係**: タスク1完了後
- **状態**: 未着手

### タスク3: 実際のn8nサーバーでのE2Eテスト
- **説明**:
  - 環境変数 `N8N_URL`, `N8N_API_KEY` を実際のn8nサーバーに設定
  - テストファイル: src/tools/implementations/__tests__/e2e.test.ts
  - 実際の実行IDを使用してget_executionを呼び出し
  - 実際のnodeNameを使用してget_execution_by_nodeを呼び出し
  - レスポンスが正しいことを確認
  - エラーケース（存在しない実行ID、nodeName）のテスト
- **開始日時**: （未着手の場合は空欄）
- **TDDステップ**:
  - [ ] Red: E2Eテストケース作成（実際のn8nサーバー使用）
  - [ ] Green: 実際のAPIを呼び出すテスト実装
  - [ ] Refactor: テストの安定性向上（リトライロジック追加）
- **依存関係**: タスク2完了後
- **状態**: 未着手

### タスク4: Claude CodeからのMCP経由動作確認
- **説明**:
  - MCPサーバーをstdioモードで起動（`pnpm start`）
  - Claude Codeから実際に2ツールを呼び出す
  - シナリオ1: 「実行exec-123の状態を確認して」→ Claude Codeがget_executionを呼び出す
  - シナリオ2: 「実行exec-456のエラー原因を調べて」→ Claude Codeがget_execution → get_execution_by_nodeを呼び出す
  - AIエージェントが適切にツールを選択し、人間ユーザーに結果を報告できることを確認
- **開始日時**: （未着手の場合は空欄）
- **TDDステップ**:
  - [ ] Red: 手動テストのチェックリスト作成
  - [ ] Green: 実際にClaude Codeから動作確認
  - [ ] Refactor: 動作確認結果をドキュメントに反映
- **依存関係**: タスク3完了後
- **状態**: 未着手

### タスク5: overview.mdの更新（Phase完了状態の反映）
- **説明**:
  - specs/progressive-execution-loading/overview.mdのPhase概要と依存関係セクションを更新
  - Phase 1-8の状態を「完了」に変更
  - 開始日時と終了日時を記録
  - プロジェクトの成果物リストを更新（実装済みクラスとテストファイル）
- **開始日時**: （未着手の場合は空欄）
- **TDDステップ**:
  - [ ] Red: overview.mdの完了状態を検証するテスト作成
  - [ ] Green: overview.md更新
  - [ ] Refactor: 最終レビューと整合性確認
- **依存関係**: タスク4完了後
- **状態**: 未着手

## テスト戦略

- **E2Eテスト**:
  - 実際のn8nサーバーを使用した動作確認
  - Claude CodeからのMCP経由動作確認
- **手動テスト**:
  - ドキュメントのレビュー（誤字脱字、明確性）
  - AIエージェントの判断ロジックのシミュレーション

## Phase完了条件
- [ ] 全タスク完了
- [ ] 全テスト通過
- [ ] 品質チェックコマンドが成功（`pnpm run type-check`, `pnpm run lint`, `pnpm run test`）
- [ ] CLAUDE.mdに2つの新ツールが記載されている
- [ ] 実際のn8nサーバーでのE2Eテストが成功
- [ ] Claude CodeからのMCP経由動作確認が成功
- [ ] overview.mdのPhase状態が全て「完了」

## 技術的課題と解決方針

**課題1: 実際のn8nサーバーへのアクセス**
- E2Eテストには実際のn8nサーバーが必要
- 解決方針: ローカルにn8nサーバーを起動、またはクラウドのn8nインスタンスを使用
- 代替案: Dockerでn8nサーバーを起動

**課題2: 実行データの準備**
- E2Eテストには実際の実行データが必要
- 解決方針: テスト用のワークフローを手動で実行し、実行IDを記録

**課題3: Claude Codeからの動作確認**
- Claude Codeのセットアップが必要
- 解決方針: Claude CodeのMCP設定ファイル（`.claude_code/config.json`）にn8n-mcp-serverを登録

## リスク管理

**リスク1: n8nサーバーが利用不可**
- 影響度: 高（E2Eテストが実施できない）
- 対策: Dockerでローカルにn8nサーバーを起動
- 緩和策: E2Eテストをスキップし、統合テストで代替

**リスク2: Claude Codeのセットアップエラー**
- 影響度: 中
- 対策: Claude Codeのドキュメントを参照してセットアップ
- 緩和策: 手動でMCPプロトコルを送信してテスト

## 次Phaseへの引き継ぎ事項

**プロジェクト完了**:
- Progressive Execution Loading機能の実装完了
- 2つの新ツール（get_execution, get_execution_by_node）の提供
- AIエージェント向けの段階的データ取得機構の実現

**未解決の課題**:
- なし（プロジェクト完了）

**技術的負債**:
- なし
