# Phase 2: 個別ツールのエラーケース検証 計画書

## タスク目次

- 1. [ワークフローツールのエラーケーステスト作成] - 状態: 未着手 - TDD: ⬜ Red / ⬜ Green / ⬜ Refactor
- 2. [実行ツールのエラーケーステスト作成] - 状態: 未着手 - TDD: ⬜ Red / ⬜ Green / ⬜ Refactor
- 3. [既存テストの修正とリファクタリング] - 状態: 未着手 - TDD: ⬜ Red / ⬜ Green / ⬜ Refactor
- 4. [Phase完了確認と品質チェック] - 状態: 未着手 - TDD: ⬜ Red / ⬜ Green / ⬜ Refactor

**番号付けルール:**
- 全タスクは直列実行（依存関係あり）

## Phase概要
- **Phase名**: 個別ツールのエラーケース検証
- **状態**: 未着手
- **目標**:
  - 10個の既存ツールで実際のエラーシナリオが正しく処理されることを検証
  - 既存テストの修正（エラーレスポンス形式変更に対応）

## TDD & 設計原則の適用

### TDDアプローチ
このPhaseでは以下のTDDサイクルを適用します：

1. **Red（テスト作成）**: 各ツールのエラーケーステストを作成（モックされたn8nクライアントがエラーをthrow）
2. **Green（最小実装）**: 必要に応じてツール実装を調整（通常は調整不要、BaseToolで対応済み）
3. **Refactor（リファクタリング）**: 既存テストの修正とコードの最適化

### 設計原則の適用方針

- **単一責任の原則 (SRP)**: 各テストケースは1つのエラーシナリオのみを検証
- **開放/閉鎖の原則 (OCP)**: テストケースの追加が容易な構造
- **リスコフの置換原則 (LSP)**: 全ツールが同じエラーハンドリングパターンに従う
- **最小限の公開**: テスト用のモックは必要最小限に
- **依存性逆転の原則 (DIP)**: n8nClientはモックを注入してテスト

## 依存関係
- **前提条件**: Phase 1のBaseToolエラーハンドリング実装完了
- **ブロッカー**: なし
- **後続Phaseへの影響**: Phase 3が依存（全ツールのエラーケース検証完了）

## 実装する機能
- 10個のツールのエラーケーステスト追加
- 既存テストのエラーレスポンス形式への対応
- E2Eテストの追加

## タスク詳細

### タスク1: ワークフローツールのエラーケーステスト作成
- **説明**:
  - ワークフロー管理ツール（8ツール）のエラーケーステストを作成
  - 対象ツール:
    - ListWorkflowsTool
    - GetWorkflowTool
    - GetWorkflowConnectionsTool
    - CreateWorkflowTool
    - CreateWorkflowFromFileTool
    - UpdateWorkflowTool
    - ReplaceWorkflowFromFileTool
    - DeleteWorkflowTool
  - 各ツールで共通のエラーケース:
    - NotFoundError: 存在しないワークフローID
    - ApiError: n8n API制約違反（read-only field更新など）
  - ツール固有のエラーケース:
    - CreateWorkflowFromFileTool: ファイル読み込みエラー
    - ReplaceWorkflowFromFileTool: ファイル読み込みエラー
  - テストファイル配置:
    - `tests/tools/implementations/list-workflows-tool.test.ts`
    - `tests/tools/implementations/get-workflow-tool.test.ts`
    - etc.
  - 各テストケースで検証する項目:
    - response.isError === true
    - response.content[0].text === error.message
- **開始日時**: （未着手の場合は空欄）
- **TDDステップ**:
  - [x] Red: テストケース作成（このタスクで実施）
  - [ ] Green: 必要に応じてツール実装を調整
  - [ ] Refactor: リファクタリング
- **依存関係**: Phase 1完了後
- **状態**: 未着手

### タスク2: 実行ツールのエラーケーステスト作成
- **説明**:
  - 実行管理ツール（2ツール）のエラーケーステストを作成
  - 対象ツール:
    - ListExecutionsTool
    - GetExecutionTool
  - 各ツールで共通のエラーケース:
    - NotFoundError: 存在しない実行ID
    - ApiError: n8n API制約違反
  - テストファイル配置:
    - `tests/tools/implementations/list-executions-tool.test.ts`
    - `tests/tools/implementations/get-execution-tool.test.ts`
  - 各テストケースで検証する項目:
    - response.isError === true
    - response.content[0].text === error.message
- **開始日時**: （未着手の場合は空欄）
- **TDDステップ**:
  - [x] Red: テストケース作成（このタスクで実施）
  - [ ] Green: 必要に応じてツール実装を調整
  - [ ] Refactor: リファクタリング
- **依存関係**: タスク1完了後（並列実行も可能だが、パターン統一のため直列）
- **状態**: 未着手

### タスク3: 既存テストの修正とリファクタリング
- **説明**:
  - 既存の成功ケーステストを確認
  - エラーレスポンス形式変更の影響を確認（影響は軽微なはず）
  - テストコードのリファクタリング:
    - 重複するモック設定の共通化
    - テストケースの整理
  - 全テストが通ることを確認
- **開始日時**: （未着手の場合は空欄）
- **TDDステップ**:
  - [ ] Red: テストケース作成（タスク1, 2で完了）
  - [ ] Green: ツール実装調整（必要に応じて）
  - [x] Refactor: リファクタリング（このタスクで実施）
- **依存関係**: タスク2完了後（全エラーケーステスト作成完了）
- **状態**: 未着手

### タスク4: Phase完了確認と品質チェック
- **説明**:
  - 全テストの実行と確認（`pnpm run test`）
  - カバレッジの確認（`pnpm run test:coverage`）
  - 型チェックの実行（`pnpm run type-check`）
  - Lintの実行（`pnpm run lint`）
  - Buildの実行（`pnpm run build`）
  - 全てのチェックに合格することを確認
- **開始日時**: （未着手の場合は空欄）
- **TDDステップ**: なし（品質チェックのため）
- **依存関係**: タスク3完了後（リファクタリング完了）
- **状態**: 未着手

## テスト戦略

- **E2Eテスト**: 各ツールの実際のエラーシナリオを検証
  - モックされたn8nClientがエラーをthrow
  - ツールのhandler()を呼び出し
  - 返却されたToolResponseを検証
- **カバレッジ目標**: 主要エラーケースをカバー（10ツール × 2-3エラー種別 = 20-30ケース）

## Phase完了条件
- [ ] 全タスク完了
- [ ] 全テスト通過（`pnpm run test`）
- [ ] 型チェック成功（`pnpm run type-check`）
- [ ] Lint成功（`pnpm run lint`）
- [ ] Build成功（`pnpm run build`）
- [ ] エラーケーステストカバレッジ目標達成（20-30ケース）

## 技術的課題と解決方針

### 課題1: モック設定の複雑化
- **課題**: 各ツールでn8nClientのモック設定が必要
- **解決方針**: 共通のモックヘルパー関数を作成して再利用

### 課題2: テストケース数の増加
- **課題**: 10ツール × 複数エラーケースでテストケースが多数
- **解決方針**:
  - パラメータ化テスト（it.each）を活用
  - 共通パターンはヘルパー関数に抽出

## リスク管理

### リスク1: 既存テストの修正範囲が予想より大きい
- **発生確率**: 低
- **影響度**: 中
- **対策**: エラーレスポンス形式は後方互換を維持（影響は軽微）
- **回避策**: タスク3で慎重に確認・修正

### リスク2: テストケース作成に時間がかかる
- **発生確率**: 中
- **影響度**: 低
- **対策**: 共通パターンの活用で効率化
- **回避策**: 優先度の高いツールから順次実施

## 次Phaseへの引き継ぎ事項

### Phase 3で利用可能になる機能
- 全ツールのエラーケースが検証済み
- エラーレスポンス形式が標準化されたことを確認
- テストカバレッジが向上

### 未解決の課題
- なし（Phase 2で全て解決予定）

### 技術的負債
- なし
